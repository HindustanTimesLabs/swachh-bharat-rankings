function ready(e,r){function a(e,r){var a=svg_slider.selectAll(".slider-bar").data(e,function(t){return t.id}),n=svg_slider.selectAll(".slider-handle").data(e,function(t){return t.id}),l=svg_slider.selectAll(".slider-bar-text").data(e,function(t){return t.id});r?(a.transition(t).attr("width",function(t){return slider_scale(t.value)}).attr("x",function(t,e){return slider_scale(s(t,e))}),n.transition(t).attr("x",function(t,e){return 0!=e?slider_scale(s(t,e))-slider_handle_width/2:-1e7}),l.transition(t).attr("x",function(t,r){return i(t,r,e)}).style("opacity",function(t,e){return t.value<=resp.slider_text_disappear?0:1}).text(function(t,e){return t.value<=resp.slider_text_disappear?"":t.value+"%"})):(a.attr("width",function(t){return slider_scale(t.value)}).attr("x",function(t,e){return slider_scale(s(t,e))}),n.attr("x",function(t,e){return 0!=e?slider_scale(s(t,e))-slider_handle_width/2:-1e7}),l.attr("x",function(t,r){return i(t,r,e)}).style("opacity",function(t,e){return t.value<=5?0:1}).text(function(t,e){return t.value<=5?"":t.value+"%"})),a.enter().append("rect").attr("class","slider-bar").attr("width",function(t){return slider_scale(t.value)}).attr("height",slider_height).attr("x",function(t,e){return slider_scale(s(t,e))}).attr("fill",function(t,e){return colors[e]}),n.enter().append("rect").attr("class",function(t){return"slider-handle "+t.id}).attr("width",slider_handle_width).attr("height",slider_height).attr("x",function(t,e){return 0!=e?slider_scale(s(t,e))-slider_handle_width/2:-1e7}).call(d3.drag().on("drag",o)),l.enter().append("text").attr("class","slider-bar-text").attr("x",function(t,r){return i(t,r,e)}).attr("dy",".4em").attr("y",slider_height/2).text(function(t){return t.value<=5?"":t.value+"%"})}function s(t,e){for(var r=[],a=0;a<e;a++)r.push(sliders[a].value);return d3.sum(r)}function i(t,e,r){return 0==e?slider_scale(t.value/2):1==e?slider_scale(r[e-1].value)+slider_scale(t.value/2):2==e?slider_scale(r[e-1].value)+slider_scale(r[e-2].value)+slider_scale(t.value/2):void 0}function n(t){return t.dox=+t.dox,t.ground=+t.ground,t.citizen=+t.citizen,t.old_rank=+t.rank,t.new_rank=+t.rank,t.start_pct=+t.start_pct,t.start_rank=+t.start_rank,t.slug=slugify(t.city),t}function l(t){function e(t){return t.total_score=t.dox*a+t.ground*s+t.citizen*i,t.total_pct=t.total_score/(a/100+s/100+i/100),t}var a=t[0].value,s=t[1].value,i=t[2].value;return r.forEach(e),r=_.sortBy(r,"total_score").reverse(),r.forEach(function(t,e){return t.new_rank=e+1,t}),r}function c(t,e,r){"ground"==t.id?(sliders[0].value=r,sliders[1].value=100-r-sliders[2].value):(sliders[1].value=r-sliders[0].value,sliders[2].value=100-r),a(sliders,!1)}function o(t,e){$(".button").removeClass("active");var r=d3.mouse(this)[0],a=1==e?"left":"right",s=slider_scale("left"==a?0:sliders[0].value),i=slider_scale("left"==a?100-sliders[2].value:100);r=r<=s?s:r>=i?i:r,c(t,e,Math.round(slider_scale.invert(r))),svg_slider.select(".slider-handle."+t.id).attr("x",r-slider_handle_width/2),d(l(sliders),!1)}function d(e,r){function a(t){var e=t.old_rank-t.new_rank;return e=e>0?"<i style='color:#91cf60' class='fa fa-caret-up' aria-hidden='true'></i></sub> "+e:0==e?e:"<i style='color:#fc8d59' class='fa fa-caret-down' aria-hidden='true'></i></sub> "+e*-1,"<td>"+t.city+"</td><td>"+t.new_rank+"</td><td>"+t.old_rank+"</td><td>"+e+"</td>"}var s=table_body.selectAll("tr").data(e),i=svg_scatter.selectAll(".city-dot").data(e,function(t){return t.city}),n=voronoiGroup.selectAll("path").data(voronoi(e).polygons(),function(t){return t.data.city});if(n.attr("d",function(t){return t?"M"+t.join("L")+"Z":null}),s.attr("class",function(t){return"table-row "+slugify(t.city)}).html(a),r?i.transition(t).attr("cx",function(t){return xScale_scatter(t.total_pct)}).attr("fill",function(t){return color_scale_scatter(t.total_pct-t.start_pct)}):i.attr("cx",function(t){return xScale_scatter(t.total_pct)}).attr("fill",function(t){return color_scale_scatter(t.total_pct-t.start_pct)}),s.enter().append("tr").attr("class",function(t){return"table-row "+slugify(t.city)}).html(a),i.enter().append("circle").attr("class",function(t){return"city-dot "+slugify(t.city)}).attr("r",4).attr("cx",function(t){return xScale_scatter(t.total_pct)}).attr("cy",function(t){return yScale_scatter(t.start_pct)}).attr("fill",function(t){return color_scale_scatter(t.total_pct-t.start_pct)}).on("mouseover",u).on("mouseout",h),n.enter().append("path").attr("d",function(t){return t?"M"+t.join("L")+"Z":null}).on("mouseover",function(t){u(t.data)}).on("mouseout",h),$(".city-dot").hasClass("highlight")){var l=$(".city-dot.highlight").attr("class"),c=_.where(e,{slug:l.split(" ")[1].split(" ")[0]});u(c[0]),$(".table-row").hide(),$(".table-row."+slugify(c[0].city)).show()}}function u(t,e){$(".scatter-line").remove(),$(".scatter-line-text").remove(),$(".city-dot").removeClass("highlight"),$(".city-dot."+slugify(t.city)).addClass("highlight"),$(".table-row").hide(),$(".table-row."+slugify(t.city)).show();var r=xScale_scatter(t.total_pct),a=yScale_scatter(t.start_pct);svg_scatter.append("line").attr("class","scatter-line x").attr("x1",r).attr("x2",r).attr("y1",a).attr("y2",height_scatter),svg_scatter.append("line").attr("class","scatter-line y").attr("x1",0).attr("x2",r).attr("y1",a).attr("y2",a),svg_scatter.append("text").attr("class","scatter-line-text").attr("x",r).attr("y",a).attr("dy","-0.5em").attr("text-anchor",r<width_scatter/2?"start":"end").text(t.city),d3.select(".city-dot."+slugify(t.city)).moveToFront(),(!e||ww<=768)&&$(".city-search select").val(t.city).trigger("chosen:updated")}function h(){var t=event.clientX,e=event.clientY,r=document.elementFromPoint(t,e),a=$(r).attr("class");if("scatter-line-text"!=(a=void 0==a?"":a)&&"scatter-line"!=a.split(" ")[0]){$(".scatter-line").remove(),$(".scatter-line-text").remove(),$(".city-dot").removeClass("highlight");var s=void 0==$(r)[0]?"":$(r)[0].nodeName;"TD"!=s&&"TBODY"!=s&&"text"!=s&&"svg"!=s&&"DIV"!=s&&""!=s&&"P"!=s&&"SPAN"!=s||($(".table-row").show(),$(".city-search select").val("").trigger("chosen:updated"))}}$(".city-search select").append("<option value=''>"+resp.empty_option+"</option>"),r.map(function(t){return t.city}).sort().forEach(function(t){$(".city-search select").append("<option>"+t+"</option>")}),$(".city-search select").chosen({allow_single_deselect:!0,width:"100%"}),svg_scatter.append("g").attr("class","x axis").attr("transform","translate(0,"+height_scatter+")").call(xAxis_scatter).append("text").attr("class","l").attr("x",width_scatter).attr("y",-5).attr("text-anchor","end").text("Your score"),svg_scatter.append("g").attr("class","y axis").call(yAxis_scatter).append("text").attr("class","l").attr("x",5).attr("y",5).attr("text-anchor","start").text("Government's score"),a(sliders,!1),r.forEach(n),d(l(sliders),!1);var p={reset:[45,25,30],dox:[100,0,0],ground:[0,100,0],citizen:[0,0,100],equal:[33,34,33]};$(".presets .button").click(function(){$(".presets .button").removeClass("active");var t=$(this).attr("data-button");"reset"!=t&&$(this).addClass("active"),"dox"==t?(d3.select(".slider-handle.ground").moveToFront(),d3.selectAll(".slider-bar-text").moveToFront()):"citizen"==t&&(d3.select(".slider-handle.citizen").moveToFront(),d3.selectAll(".slider-bar-text").moveToFront()),p[t].forEach(function(t,e){sliders[e].value=t}),a(sliders,!0),d(l(sliders),!0)}),$(".city-search select").change(function(){var t=$(this).val(),e=_.where(r,{city:t});0==e.length?($(".table-row").show(),h()):u(e[0],!0)}),ww<=768&&$(".chart-wrapper").hide()}function slugify(t){return t.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}var ww=$(window).width(),resp={};ww<=768?(resp.slider_margin_horizontal=5,resp.slider_height=30,resp.slider_handle_width=20,resp.slider_text_disappear=10,resp.empty_option="-- Select a city --",$(".button.special.dox").text("Documentation"),$(".button.special.ground").text("Assessment"),$(".button.special.citizen").text("Citizens"),$(".button.equal").text("Equal")):(resp.slider_margin_horizontal=12,resp.slider_height=20,resp.slider_handle_width=10,resp.slider_text_disappear=5,resp.empty_option="",$(".button.special.dox").text("Documentation only"),$(".button.special.ground").text("Ground assessment only"),$(".button.special.citizen").text("Citizen feedback only"),$(".button.equal").text("All three are equal"));var sliders=[{id:"dox",name:"Documentation",value:45},{id:"ground",name:"Ground assessment",value:25},{id:"citizen",name:"Citizen reports",value:30}],slider_margin={top:0,right:resp.slider_margin_horizontal,bottom:0,left:resp.slider_margin_horizontal},slider_width=$("#sliders-wrapper").width()-slider_margin.left-slider_margin.right,slider_height=resp.slider_height-slider_margin.top-slider_margin.bottom,slider_handle_width=resp.slider_handle_width,svg_slider=d3.select("#sliders-wrapper").append("svg").attr("width",slider_width+slider_margin.left+slider_margin.right).attr("height",slider_height+slider_margin.top+slider_margin.bottom).append("g").attr("transform","translate("+slider_margin.left+","+slider_margin.top+")"),slider_scale=d3.scaleLinear().range([0,slider_width]).domain([0,100]),colors=["#334d5c","#45b29d","#df5a49"],margin_scatter={top:20,bottom:25,left:25,right:10},width_scatter=$("#chart").width()-margin_scatter.left-margin_scatter.right,height_scatter=$("#chart").width()-margin_scatter.top-margin_scatter.bottom,svg_scatter=d3.select("#chart").append("svg").attr("width",width_scatter+margin_scatter.left+margin_scatter.right).attr("height",height_scatter+margin_scatter.top+margin_scatter.bottom).append("g").attr("transform","translate("+margin_scatter.left+", "+margin_scatter.top+")"),color_scale_scatter=chroma.scale(["#e66101","#fdb863","#b2abd2","#5e3c99"]).domain([-25,25]),xScale_scatter=d3.scaleLinear().range([0,width_scatter]).domain([0,100]),yScale_scatter=d3.scaleLinear().range([height_scatter,0]).domain([0,100]),xAxis_scatter=d3.axisBottom().scale(xScale_scatter),yAxis_scatter=d3.axisLeft().scale(yScale_scatter),voronoi=d3.voronoi().x(function(t){return xScale_scatter(t.total_pct)}).y(function(t){return yScale_scatter(t.start_pct)}).extent([[0,0],[width_scatter,height_scatter]]),voronoiGroup=svg_scatter.append("g").attr("class","voronoi");svg_scatter.append("line").attr("class","xy-line").attr("x1",0).attr("x2",width_scatter).attr("y1",height_scatter).attr("y2",0).style("stroke","#000");var table_body=d3.select("table").append("tbody"),t=d3.transition().duration(2e3);d3.queue().defer(d3.csv,"data/data.csv").await(ready),$(".view-select").on("click",function(){var t=$(".view-select .booton").attr("mutton");console.log(t),"chart"==t?($(".view-select .booton").attr("mutton","table"),$(".view-select .booton").text("View table"),$(".chart-wrapper").show(),$(".table-wrapper table").hide()):($(".view-select .booton").attr("mutton","chart"),$(".view-select .booton").text("View chart"),$(".chart-wrapper").hide(),$(".table-wrapper table").show())});